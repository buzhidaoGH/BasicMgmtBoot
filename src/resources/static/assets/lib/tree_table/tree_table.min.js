layui.define(['layer','laytpl','form'],function(exports){var $=layui.jquery;var layer=layui.layer;var laytpl=layui.laytpl;var form=layui.form;var device=layui.device();var MOD_NAME='treeTable';var TreeTable=function(options){var defaultOption={elem:undefined,data:[],cols:[],reqData:undefined,width:undefined,height:undefined,cellMinWidth:100,skin:undefined,size:undefined,even:undefined,style:undefined,getThead:function(){return getThead(this)},getAllChooseBox:function(){return getAllChooseBox(this)},getColgroup:function(){return getColgroup(this)},getTbWidth:function(){return getTbWidth(this)},tree:{},text:{}};var treeDefaultOption={idName:'id',pidName:'pid',childName:'children',haveChildName:'haveChild',openName:'open',isPidData:false,iconIndex:0,arrowType:undefined,onlyIconControl:false,getIcon:function(d){return getIcon(d,this)}};var textDefaultOption={none:'<div style="padding: 18px 0;">暂无数据</div>'};this.options=$.extend(defaultOption,options);this.options.tree=$.extend(treeDefaultOption,options.tree);this.options.text=$.extend(textDefaultOption,options.text);for(var i=0;i<options.cols.length;i++){var colDefaultOption={field:undefined,title:undefined,align:undefined,templet:undefined,toolbar:undefined,width:undefined,type:undefined,style:undefined,fixed:undefined,unresize:false};this.options.cols[i]=$.extend(colDefaultOption,options.cols[i])}this.init();this.bindEvents()};TreeTable.prototype.init=function(){var options=this.options;var tbFilter=options.elem.substring(1);var $elem=$(options.elem);$elem.removeAttr('lay-filter');$elem.next('.ew-tree-table').remove();var viewHtml='<div class="layui-form ew-tree-table" style="'+(options.style||'')+'">';viewHtml+='      <div class="ew-tree-table-group">';viewHtml+='         <div class="ew-tree-table-head">';viewHtml+='            <table class="layui-table"></table>';viewHtml+='            <div class="ew-tree-table-border bottom"></div>';viewHtml+='         </div>';viewHtml+='         <div class="ew-tree-table-box">';viewHtml+='            <table class="layui-table"></table>';viewHtml+='            <div class="ew-tree-table-loading"><i class="layui-icon layui-anim layui-anim-rotate layui-anim-loop">&#xe63d;</i></div>';viewHtml+='            <div class="ew-tree-table-empty" style="display: none;">'+(options.text.none||'')+'</div>';viewHtml+='         </div>';viewHtml+='      </div>';viewHtml+='      <div class="ew-tree-table-border top"></div><div class="ew-tree-table-border left"></div>';viewHtml+='      <div class="ew-tree-table-border right"></div><div class="ew-tree-table-border bottom"></div>';viewHtml+='   </div>';$elem.after(viewHtml);var components=this.getComponents();var $view=components.$view;$view.attr('lay-filter',tbFilter);var $group=components.$group;var $tbBox=components.$tbBox;var $table=components.$table;var $headTb=components.$headTb;var $tbEmpty=components.$tbEmpty;var $tbLoading=components.$tbLoading;options.skin&&$table.attr('lay-skin',options.skin);options.size&&$table.attr('lay-size',options.size);options.even&&$table.attr('lay-even',options.even);if(device.ie){$view.find('.ew-tree-table-border.bottom').css('height','1px');$view.find('.ew-tree-table-border.right').css('width','1px')}if(options.width){$view.css('width',options.width);$headTb.parent().css('width',options.width);$tbBox.css('width',options.width)}var tbWidth=options.getTbWidth();if(tbWidth.needSet){$table.css('min-width',tbWidth.minWidth);$headTb.css('min-width',tbWidth.minWidth)}var colgroupHtmlStr=options.getColgroup();var headHtmlStr=colgroupHtmlStr+'<thead>'+options.getThead()+'</thead>';if(options.height){$table.html(colgroupHtmlStr+'<tbody></tbody>');$headTb.html(headHtmlStr);$table.css('margin-top','-1px');if(options.height.indexOf('full-')==0){var h=parseFloat(options.height.substring(5));var cssStr='<style>.ew-tree-table > .ew-tree-table-group > .ew-tree-table-box {';cssStr+='      height: '+(getPageHeight()-h)+'px;';cssStr+='      height: -moz-calc(100vh - '+h+'px);';cssStr+='      height: -webkit-calc(100vh - '+h+'px);';cssStr+='      height: calc(100vh - '+h+'px);';cssStr+='   }</style>';$tbBox.after(cssStr);$tbBox.attr('ew-tree-full',h)}else{$tbBox.css('height',options.height)}}else{$table.html(headHtmlStr+'<tbody></tbody>')}form.render('checkbox',tbFilter);if(options.reqData){this.renderBodyAsync()}else{if(options.data&&options.data.length>0){if(options.tree.isPidData){options.data=treeTb.pidToChildren(options.data,options.tree.idName,options.tree.pidName,options.tree.childName)}else{addPidField(options.data,options.tree)}$table.children('tbody').html(this.renderBody(options.data));$tbLoading.hide();this.renderNumberCol();form.render(null,tbFilter);this.checkChooseAllCB();updateFixedTbHead($view)}else{$tbLoading.hide();$tbEmpty.show()}}};TreeTable.prototype.bindEvents=function(){var that=this;var options=this.options;var components=this.getComponents();var $view=components.$view;var $table=components.$table;var $tbEmpty=components.$tbEmpty;var tbFilter=components.tbFilter;var checkboxFilter=components.checkboxFilter;var radioFilter=components.radioFilter;var cbAllFilter=components.cbAllFilter;var $tbody=$table.children('tbody');var commonMember=function(ext){var $tr=$(this);if(!$tr.is('tr')){$tr=$tr.parentsUntil('tr[data-id]').parent()}var id=$tr.data('id');var data=getDataById(options.data,id,options.tree);var obj={tr:$tr,data:data,del:function(){var indent=parseInt(this.tr.data('indent'));this.tr.nextAll('tr').each(function(){if(parseInt($(this).data('indent'))<=indent){return false}$(this).remove()});var $parentTr=this.tr.prevAll('tr');this.tr.remove();delDataById(options.data,id,options.tree);if(!options.data||options.data.length<=0){$tbEmpty.show()}that.renderNumberCol();$parentTr.each(function(){var tInd=parseInt($(this).data('indent'));if(tInd<indent){that.checkParentCB($(this));indent=tInd}});that.checkChooseAllCB()},update:function(fields){data=$.extend(data,fields);var indent=parseInt(this.tr.data('indent'));that.renderBodyTr(data,indent,undefined,this.tr);form.render(null,tbFilter);that.checkIndeterminateCB();that.checkChooseAllCB()}};return $.extend(obj,ext)};$tbody.off('click.fold').on('click.fold','.ew-tree-pack',function(e){layui.stope(e);var $tr=$(this).parent().parent();if($tr.hasClass('ew-tree-table-loading')){return}var haveChild=$tr.data('have-child');if(haveChild!=true&&haveChild!='true'){return}var id=$tr.data('id');var isOpen=$tr.hasClass('ew-tree-table-open');var data=getDataById(options.data,id,options.tree);if(!isOpen&&(!data[options.tree.childName]||data[options.tree.childName].length<=0)){that.renderBodyAsync(data,$tr)}else{toggleRow($tr)}});$tbody.off('click.tool').on('click.tool','*[lay-event]',function(e){layui.stope(e);var $this=$(this);layui.event.call(this,MOD_NAME,'tool('+tbFilter+')',commonMember.call(this,{event:$this.attr('lay-event')}))});form.on('radio('+radioFilter+')',function(data){var d=getDataById(options.data,data.value,options.tree);that.removeAllChecked();d.LAY_CHECKED=true;layui.event.call(this,MOD_NAME,'checkbox('+tbFilter+')',{checked:true,data:d,type:'one'})});form.on('checkbox('+checkboxFilter+')',function(data){var checked=data.elem.checked;var $cb=$(data.elem);var $layCb=$cb.next('.layui-form-checkbox');if(!checked&&$layCb.hasClass('ew-form-indeterminate')){checked=true;$cb.prop('checked',checked);$cb.data('indeterminate','false');$layCb.addClass('layui-form-checked');$layCb.removeClass('ew-form-indeterminate')}var d=getDataById(options.data,data.value,options.tree);d.LAY_CHECKED=checked;var $tr=$cb.parentsUntil('tr').parent();if(d[options.tree.childName]&&d[options.tree.childName].length>0){that.checkSubCB($tr,checked)}var indent=parseInt($tr.data('indent'));$tr.prevAll('tr').each(function(){var tInd=parseInt($(this).data('indent'));if(tInd<indent){that.checkParentCB($(this));indent=tInd}});that.checkChooseAllCB();layui.event.call(this,MOD_NAME,'checkbox('+tbFilter+')',{checked:checked,data:d,type:'one'})});form.on('checkbox('+cbAllFilter+')',function(data){var checked=data.elem.checked;var $cb=$(data.elem);var $layCb=$cb.next('.layui-form-checkbox');if(!options.data||options.data.length<=0){$cb.prop('checked',false);$cb.data('indeterminate','false');$layCb.removeClass('layui-form-checked ew-form-indeterminate');return}if(!checked&&$layCb.hasClass('ew-form-indeterminate')){checked=true;$cb.prop('checked',checked);$cb.data('indeterminate','false');$layCb.addClass('layui-form-checked');$layCb.removeClass('ew-form-indeterminate')}layui.event.call(this,MOD_NAME,'checkbox('+tbFilter+')',{checked:checked,data:undefined,type:'all'});that.checkSubCB($table.children('tbody'),checked)});$tbody.off('click.row').on('click.row','tr',function(){layui.event.call(this,MOD_NAME,'row('+tbFilter+')',commonMember.call(this,{}))});$tbody.off('dblclick.rowDouble').on('dblclick.rowDouble','tr',function(){layui.event.call(this,MOD_NAME,'rowDouble('+tbFilter+')',commonMember.call(this,{}))});$tbody.off('click.cell').on('click.cell','td',function(e){var $td=$(this);var type=$td.data('type');if(type=='checkbox'||type=='radio'){layui.stope(e);return}var edit=$td.data('edit');var field=$td.data('field');if(edit){layui.stope(e);if($tbody.find('.ew-tree-table-edit').length>0){return}var index=$td.data('index');var indentSize=$td.children('.ew-tree-table-indent').length;var id=$td.parent().data('id');var d=getDataById(options.data,id,options.tree);if('text'==edit||'number'==edit){var $input=$('<input type="'+edit+'" class="layui-input ew-tree-table-edit"/>');$input[0].value=d[field];$td.append($input);$input.focus();$input.blur(function(){var value=$(this).val();if(value==d[field]){$(this).remove();return}var rs=layui.event.call(this,MOD_NAME,'edit('+tbFilter+')',commonMember.call(this,{value:value,field:field}));if(rs==false){$(this).addClass('layui-form-danger');$(this).focus()}else{d[field]=value;that.renderBodyTd(d,indentSize,index,$td)}})}else{console.error('不支持的单元格编辑类型:'+edit)}}else{var rs=layui.event.call(this,MOD_NAME,'cell('+tbFilter+')',commonMember.call(this,{td:$td,field:field}));if(rs==false){layui.stope(e)}}});$tbody.off('dblclick.cellDouble').on('dblclick.cellDouble','td',function(e){var $td=$(this);var type=$td.data('type');if(type=='checkbox'||type=='radio'){layui.stope(e);return}var edit=$td.data('edit');var field=$td.data('field');if(edit){layui.stope(e)}else{var rs=layui.event.call(this,MOD_NAME,'cellDouble('+tbFilter+')',commonMember.call(this,{td:$td,field:field}));if(rs==false){layui.stope(e)}}});components.$tbBox.on('scroll',function(){var $this=$(this);var scrollLeft=$this.scrollLeft();var scrollTop=$this.scrollTop();components.$headTb.parent().scrollLeft(scrollLeft)})};TreeTable.prototype.getComponents=function(){var $view=$(this.options.elem).next();var $group=$view.children('.ew-tree-table-group');var $tbBox=$group.children('.ew-tree-table-box');var $table=$tbBox.children('.layui-table');var $headTb=$group.children('.ew-tree-table-head').children('.layui-table');var $tbEmpty=$tbBox.children('.ew-tree-table-empty');var $tbLoading=$tbBox.children('.ew-tree-table-loading');var tbFilter=$view.attr('lay-filter');var checkboxFilter='ew_tb_checkbox_'+tbFilter;var radioFilter='ew_tb_radio_'+tbFilter;var cbAllFilter='ew_tb_choose_all_'+tbFilter;return{$view:$view,$group:$group,$tbBox:$tbBox,$table:$table,$headTb:$headTb,$tbEmpty:$tbEmpty,$tbLoading:$tbLoading,tbFilter:tbFilter,checkboxFilter:checkboxFilter,radioFilter:radioFilter,cbAllFilter:cbAllFilter}};TreeTable.prototype.renderBody=function(data,indentSize,isHide){var options=this.options;var treeOption=options.tree;indentSize||(indentSize=0);var htmlStr='';for(var i=0;i<data.length;i++){var d=data[i];htmlStr+=this.renderBodyTr(d,indentSize,isHide);var children=d[treeOption.childName];if(children&&children.length>0){htmlStr+=this.renderBody(children,indentSize+1,!d[treeOption.openName])}}return htmlStr};TreeTable.prototype.renderBodyTr=function(d,indentSize,isHide,$tr){var options=this.options;var cols=options.cols;var treeOption=options.tree;indentSize||(indentSize=0);var htmlStr='';var haveChild=getHaveChild(d,treeOption);if($tr){$tr.data('pid',d[treeOption.pidName]||'');$tr.data('have-child',haveChild);$tr.data('indent',indentSize);$tr.removeClass('ew-tree-table-loading')}else{var classNames='';if(haveChild&&d[treeOption.openName]){classNames+='ew-tree-table-open'}if(isHide){classNames+='ew-tree-tb-hide'}htmlStr+='<tr class="'+classNames+'" data-id="'+d[treeOption.idName]+'"';htmlStr+=' data-pid="'+(d[treeOption.pidName]||'')+'" data-have-child="'+haveChild+'"';htmlStr+=' data-indent="'+indentSize+'">'}for(var j=0;j<cols.length;j++){var $td;if($tr){$td=$tr.children('td').eq(j)}htmlStr+=this.renderBodyTd(d,indentSize,j,$td)}htmlStr+='</tr>';return htmlStr};TreeTable.prototype.renderBodyTd=function(d,indentSize,index,$td){var options=this.options;var col=options.cols[index];var treeOption=options.tree;var components=this.getComponents();var checkboxFilter=components.checkboxFilter;var radioFilter=components.radioFilter;indentSize||(indentSize=0);var fieldStr='';if(col.type=='numbers'){fieldStr+='<span class="ew-tree-table-numbers"></span>'}else if(col.type=='checkbox'){var attrStr='name="'+checkboxFilter+'" lay-filter="'+checkboxFilter+'" value="'+d[treeOption.idName]+'"';attrStr+=d.LAY_CHECKED?' checked="checked"':'';fieldStr+='<input type="checkbox" lay-skin="primary" '+attrStr+' class="ew-tree-table-checkbox" />'}else if(col.type=='radio'){var attrStr='name="'+radioFilter+'" lay-filter="'+radioFilter+'" value="'+d[treeOption.idName]+'"';attrStr+=d.LAY_CHECKED?' checked="checked"':'';fieldStr+='<input type="radio" '+attrStr+' class="ew-tree-table-radio" />'}else if(col.templet){if(typeof col.templet=='function'){fieldStr+=col.templet(d)}else if(typeof col.templet=='string'){laytpl($(col.templet).html()).render(d,function(html){fieldStr+=html})}}else if(col.toolbar){laytpl($(col.toolbar).html()).render(d,function(html){fieldStr+=html})}else if(col.field&&d[col.field]!=undefined&&d[col.field]!=null){fieldStr+=d[col.field]}var tdStr='';if(index==treeOption.iconIndex){for(var k=0;k<indentSize;k++){tdStr+='<span class="ew-tree-table-indent"></span>'}tdStr+='<span class="ew-tree-pack">';var haveChild=getHaveChild(d,treeOption);tdStr+=('<i class="layui-icon ew-tree-table-arrow '+(haveChild?'':'ew-tree-table-arrow-hide')+' '+(options.tree.arrowType||'')+'"></i>');tdStr+=treeOption.getIcon(d);if(options.tree.onlyIconControl){tdStr+='</span>';tdStr+=('<span>'+fieldStr+'</span>')}else{tdStr+=('<span>'+fieldStr+'</span>');tdStr+='</span>'}}else{tdStr+=fieldStr}if($td&&col.type!='numbers'){$td.html(tdStr)}var htmlStr='<td data-index="'+index+'" ';col.field&&(htmlStr+=(' data-field="'+col.field+'"'));col.edit&&(htmlStr+=(' data-edit="'+col.edit+'"'));col.type&&(htmlStr+=(' data-type="'+col.type+'"'));col.align&&(htmlStr+=(' align="'+col.align+'"'));col.style&&(htmlStr+=(' style="'+col.style+'"'));htmlStr+='>';htmlStr+=(tdStr+'</td>');return htmlStr};TreeTable.prototype.renderBodyAsync=function(d,$tr){var that=this;var options=this.options;var components=this.getComponents();var $tbEmpty=components.$tbEmpty;var $tbLoading=components.$tbLoading;if($tr){$tr.addClass('ew-tree-table-loading');$tr.children('td').children('.ew-tree-pack').children('.ew-tree-table-arrow').addClass('layui-anim layui-anim-rotate layui-anim-loop')}else{if(options.data&&options.data.length>0){$tbLoading.addClass('ew-loading-float')}$tbLoading.show();$tbEmpty.hide()}options.reqData(d,function(res){if(options.tree.isPidData){res=treeTb.pidToChildren(res,options.tree.idName,options.tree.pidName,options.tree.childName)}that.renderBodyData(res,d,$tr);if($tr){$tr.removeClass('ew-tree-table-loading');$tr.children('td').children('.ew-tree-pack').children('.ew-tree-table-arrow').removeClass('layui-anim layui-anim-rotate layui-anim-loop')}else{$tbLoading.hide();$tbLoading.removeClass('ew-loading-float');if(!res||res.length==0){$tbEmpty.show()}else{$tbEmpty.hide()}}})};TreeTable.prototype.renderBodyData=function(data,d,$tr){var that=this;var options=this.options;var components=this.getComponents();var $view=components.$view;var $table=components.$table;var tbFilter=components.tbFilter;addPidField(data,options.tree,d);if(d==undefined){options.data=data}else{d[options.tree.childName]=data}var indent;if($tr){indent=parseInt($tr.data('indent'))+1}var htmlStr=this.renderBody(data,indent);if($tr){$tr.nextAll('tr').each(function(){if(parseInt($(this).data('indent'))<=(indent-1)){return false}$(this).remove()});$tr.after(htmlStr);$tr.addClass('ew-tree-table-open')}else{$table.children('tbody').html(htmlStr)}form.render(null,tbFilter);this.renderNumberCol();this.checkIndeterminateCB();if($tr){this.checkParentCB($tr);$tr.prevAll('tr').each(function(){var tInd=parseInt($(this).data('indent'));if(tInd<(indent-1)){that.checkParentCB($(this));indent=tInd+1}})}this.checkChooseAllCB();updateFixedTbHead($view)};TreeTable.prototype.checkSubCB=function($tr,checked){var that=this;var components=this.getComponents();var cbFilter=components.checkboxFilter;var indent=-1,$trList;if($tr.is('tbody')){$trList=$tr.children('tr')}else{indent=parseInt($tr.data('indent'));$trList=$tr.nextAll('tr')}$trList.each(function(){if(parseInt($(this).data('indent'))<=indent){return false}var $cb=$(this).children('td').children('input[name="'+cbFilter+'"]');$cb.prop('checked',checked);if(checked){$cb.data('indeterminate','false');$cb.next('.layui-form-checkbox').addClass('layui-form-checked');$cb.next('.layui-form-checkbox').removeClass('ew-form-indeterminate')}else{$cb.data('indeterminate','false');$cb.next('.layui-form-checkbox').removeClass('layui-form-checked ew-form-indeterminate')}that.update($(this).data('id'),{LAY_CHECKED:checked})})};TreeTable.prototype.checkParentCB=function($tr){var that=this;var components=this.getComponents();var cbFilter=components.checkboxFilter;var indent=parseInt($tr.data('indent'));var ckNum=0,unCkNum=0;$tr.nextAll('tr').each(function(){if(parseInt($(this).data('indent'))<=indent){return false}var $cb=$(this).children('td').children('input[name="'+cbFilter+'"]');if($cb.prop('checked')){ckNum++}else{unCkNum++}});var $cb=$tr.children('td').children('input[name="'+cbFilter+'"]');if(ckNum>0&&unCkNum==0){$cb.prop('checked',true);$cb.data('indeterminate','false');$cb.next('.layui-form-checkbox').addClass('layui-form-checked');$cb.next('.layui-form-checkbox').removeClass('ew-form-indeterminate');that.update($tr.data('id'),{LAY_CHECKED:true})}else if(ckNum==0&&unCkNum>0){$cb.prop('checked',false);$cb.data('indeterminate','false');$cb.next('.layui-form-checkbox').removeClass('layui-form-checked ew-form-indeterminate');that.update($tr.data('id'),{LAY_CHECKED:false})}else if(ckNum>0&&unCkNum>0){$cb.prop('checked',true);$cb.data('indeterminate','true');$cb.next('.layui-form-checkbox').addClass('layui-form-checked ew-form-indeterminate');that.update($tr.data('id'),{LAY_CHECKED:true})}};TreeTable.prototype.checkChooseAllCB=function(){var components=this.getComponents();var cbAllFilter=components.cbAllFilter;var cbFilter=components.checkboxFilter;var $tbody=components.$table.children('tbody');var ckNum=0,unCkNum=0;$tbody.children('tr').each(function(){var $cb=$(this).children('td').children('input[name="'+cbFilter+'"]');if($cb.prop('checked')){ckNum++}else{unCkNum++}});var $cb=$('input[lay-filter="'+cbAllFilter+'"]');if(ckNum>0&&unCkNum==0){$cb.prop('checked',true);$cb.data('indeterminate','false');$cb.next('.layui-form-checkbox').addClass('layui-form-checked');$cb.next('.layui-form-checkbox').removeClass('ew-form-indeterminate')}else if((ckNum==0&&unCkNum>0)||(ckNum==0&&unCkNum==0)){$cb.prop('checked',false);$cb.data('indeterminate','false');$cb.next('.layui-form-checkbox').removeClass('layui-form-checked ew-form-indeterminate')}else if(ckNum>0&&unCkNum>0){$cb.prop('checked',true);$cb.data('indeterminate','true');$cb.next('.layui-form-checkbox').addClass('layui-form-checked ew-form-indeterminate')}};TreeTable.prototype.renderNumberCol=function(){var components=this.getComponents();var $tbody=components.$table.children('tbody');$tbody.children('tr').each(function(index){$(this).children('td').find('.ew-tree-table-numbers').text(index+1)})};TreeTable.prototype.checkIndeterminateCB=function(){var components=this.getComponents();var cbFilter=components.checkboxFilter;$('input[lay-filter="'+cbFilter+'"]').each(function(){var $cb=$(this);if($cb.data('indeterminate')=='true'&&$cb.prop('checked')){$cb.next('.layui-form-checkbox').addClass('ew-form-indeterminate')}})};TreeTable.prototype.filterData=function(ids){var components=this.getComponents();var $trList=components.$table.children('tbody').children('tr');if(typeof ids=='string'){var keyword=ids;ids=[];$trList.each(function(){var id=$(this).data('id');$(this).children('td').each(function(){if($(this).text().indexOf(keyword)!=-1){ids.push(id);return false}})})}$trList.addClass('ew-tree-table-filter-hide');for(var i=0;i<ids.length;i++){var $tr=$trList.filter('[data-id="'+ids[i]+'"]');$tr.removeClass('ew-tree-table-filter-hide');var indent=parseInt($tr.data('indent'));$tr.prevAll('tr').each(function(){var tInd=parseInt($(this).data('indent'));if(tInd<indent){$(this).removeClass('ew-tree-table-filter-hide');if(!$(this).hasClass('ew-tree-table-open')){toggleRow($(this))}indent=tInd}})}};TreeTable.prototype.clearFilter=function(){var components=this.getComponents();var $trList=components.$table.children('tbody').children('tr');$trList.removeClass('ew-tree-table-filter-hide')};TreeTable.prototype.expand=function(id,cascade){var components=this.getComponents();var $tr=components.$table.children('tbody').children('tr[data-id="'+id+'"]');if(!$tr.hasClass('ew-tree-table-open')){$tr.children('td').children('.ew-tree-pack').trigger('click')}if(cascade==false){return}var indent=parseInt($tr.data('indent'));$tr.prevAll('tr').each(function(){var tInd=parseInt($(this).data('indent'));if(tInd<indent){if(!$(this).hasClass('ew-tree-table-open')){$(this).children('td').children('.ew-tree-pack').trigger('click')}indent=tInd}})};TreeTable.prototype.fold=function(id,cascade){var components=this.getComponents();var $tr=components.$table.children('tbody').children('tr[data-id="'+id+'"]');if($tr.hasClass('ew-tree-table-open')){$tr.children('td').children('.ew-tree-pack').trigger('click')}if(cascade==false){return}var indent=parseInt($tr.data('indent'));$tr.prevAll('tr').each(function(){var tInd=parseInt($(this).data('indent'));if(tInd<indent){if($(this).hasClass('ew-tree-table-open')){$(this).children('td').children('.ew-tree-pack').trigger('click')}indent=tInd}})};TreeTable.prototype.expandAll=function(){var that=this;var components=this.getComponents();var $trList=components.$table.children('tbody').children('tr');$trList.each(function(){that.expand($(this).data('id'),false)})};TreeTable.prototype.foldAll=function(){var that=this;var components=this.getComponents();var $trList=components.$table.children('tbody').children('tr');$trList.each(function(){that.fold($(this).data('id'),false)})};TreeTable.prototype.getData=function(){return this.options.data};TreeTable.prototype.reload=function(opt){treeTb.render($.extend(this.options,opt))};TreeTable.prototype.update=function(id,fields){var data=getDataById(this.getData(),id,this.options.tree);$.extend(data,fields)};TreeTable.prototype.del=function(id){delDataById(this.getData(),id,this.options.tree)};TreeTable.prototype.checkStatus=function(needIndeterminate){(needIndeterminate==undefined)&&(needIndeterminate=true);var that=this;var components=this.getComponents();var $table=components.$table;var checkboxFilter=components.checkboxFilter;var radioFilter=components.radioFilter;var list=[];var $radio=$table.find('input[name="'+radioFilter+'"]');if($radio.length>0){var id=$radio.filter(':checked').val();var d=getDataById(this.getData(),id,this.options.tree);if(d){list.push(d)}}else{$table.find('input[name="'+checkboxFilter+'"]:checked').each(function(){var id=$(this).val();var isIndeterminate=$(this).next('.layui-form-checkbox').hasClass('ew-form-indeterminate');if(needIndeterminate||!isIndeterminate){var d=getDataById(that.getData(),id,that.options.tree);if(d){d.isIndeterminate=isIndeterminate;list.push(d)}}})}return list};TreeTable.prototype.setChecked=function(ids){var components=this.getComponents();var $table=components.$table;var checkboxFilter=components.checkboxFilter;var radioFilter=components.radioFilter;var $radio=$table.find('input[name="'+radioFilter+'"]');if($radio.length>0){$radio.each(function(){if(ids[ids.length-1]==$(this).val()){$(this).next('.layui-form-radio').trigger('click');return false}})}else{$table.find('input[name="'+checkboxFilter+'"]').each(function(){var $cb=$(this);var value=$cb.val();var $layCb=$cb.next('.layui-form-checkbox');for(var i=0;i<ids.length;i++){if(value==ids[i]){var checked=$cb.prop('checked');var indeterminate=$layCb.hasClass('ew-form-indeterminate');if(!checked||indeterminate){$layCb.trigger('click')}}}})}};TreeTable.prototype.removeAllChecked=function(){var components=this.getComponents();var $table=components.$table;var checkboxFilter=components.checkboxFilter;this.checkSubCB($table.children('tbody'),false)};TreeTable.prototype.refresh=function(id,data){if(isClass(id)=='Array'){data=id;id=undefined}var components=this.getComponents();var $table=components.$table;var d,$tr;if(id!=undefined){d=getDataById(this.getData(),id,this.options.tree);$tr=$table.children('tbody').children('tr[data-id="'+id+'"]')}if(data){components.$tbLoading.addClass('ew-loading-float');components.$tbLoading.show();this.renderBodyData(data,d,$tr);components.$tbLoading.hide();components.$tbLoading.removeClass('ew-loading-float');if(data&&data.length>0){components.$tbEmpty.hide()}else{components.$tbEmpty.show()}}else{this.renderBodyAsync(d,$tr)}};function getThead(options){var htmlStr='<tr>';for(var i=0;i<options.cols.length;i++){var col=options.cols[i];htmlStr+='<td data-index="'+i+'" ';col.align&&(htmlStr+=' align="'+col.align+'"');htmlStr+=' >';if(col.type=='checkbox'){htmlStr+=options.getAllChooseBox()}else{htmlStr+=(col.title||'')}if(!col.unresize&&'checkbox'!=col.type&&'radio'!=col.type&&'numbers'!=col.type&&'space'!=col.type){htmlStr+='<span class="ew-tb-resize"></span>'}htmlStr+='</td>'}htmlStr+='</tr>';return htmlStr}function getColgroup(options){var htmlStr='<colgroup>';for(var i=0;i<options.cols.length;i++){var col=options.cols[i];htmlStr+='<col ';if(col.width){htmlStr+='width="'+col.width+'"'}else if(col.type=='space'){htmlStr+='width="15"'}else if(col.type=='numbers'){htmlStr+='width="40"'}else if(col.type=='checkbox'||col.type=='radio'){htmlStr+='width="48"'}htmlStr+=' />'}htmlStr+='</colgroup>';return htmlStr}function getTbWidth(options){var minWidth=0,needSet=false;for(var i=0;i<options.cols.length;i++){var col=options.cols[i];if(col.type=='space'){minWidth+=15}else if(col.type=='numbers'){minWidth+=40}else if(col.type=='checkbox'||col.type=='radio'){minWidth+=48}else if(!col.width||/\d+%$/.test(col.width)){needSet=true;if(col.minWidth){minWidth+=col.minWidth}else if(options.cellMinWidth){minWidth+=options.cellMinWidth}}else{minWidth+=col.width}}return{minWidth:minWidth,needSet:needSet}}function getAllChooseBox(options){var tbFilter=$(options.elem).next().attr('lay-filter');var cbAllFilter='ew_tb_choose_all_'+tbFilter;return'<input type="checkbox" lay-filter="'+cbAllFilter+'" lay-skin="primary" class="ew-tree-table-checkbox"/>'}function getIcon(d,treeOption){if(getHaveChild(d,treeOption)){return'<i class="ew-tree-icon layui-icon layui-icon-layer"></i>'}else{return'<i class="ew-tree-icon layui-icon layui-icon-file"></i>'}}function toggleRow($tr){var indent=parseInt($tr.data('indent'));var isOpen=$tr.hasClass('ew-tree-table-open');if(isOpen){$tr.removeClass('ew-tree-table-open');$tr.nextAll('tr').each(function(){if(parseInt($(this).data('indent'))<=indent){return false}$(this).addClass('ew-tree-tb-hide')})}else{$tr.addClass('ew-tree-table-open');var hideInd;$tr.nextAll('tr').each(function(){var ind=parseInt($(this).data('indent'));if(ind<=indent){return false}if(hideInd!=undefined&&ind>hideInd){return true}$(this).removeClass('ew-tree-tb-hide');if(!$(this).hasClass('ew-tree-table-open')){hideInd=parseInt($(this).data('indent'))}else{hideInd=undefined}})}updateFixedTbHead($tr.parent().parent().parent().parent().parent())}function updateFixedTbHead($view){var $group=$view.children('.ew-tree-table-group');var $headBox=$group.children('.ew-tree-table-head');var $tbBox=$group.children('.ew-tree-table-box');var sWidth=$tbBox.width()-$tbBox.prop('clientWidth');if(sWidth>0){$headBox.css('border-right',sWidth+'px solid #f2f2f2')}else{$headBox.css('border-right','none')}}$(window).resize(function(){$('.ew-tree-table').each(function(){updateFixedTbHead($(this));var $tbBox=$(this).children('.ew-tree-table-group').children('.ew-tree-table-box');var full=$tbBox.attr('ew-tree-full');if(full&&device.ie&&device.ie<10){$tbBox.css('height',getPageHeight()-full)}})});function getHaveChild(d,treeOption){var haveChild=false;if(d[treeOption.haveChildName]!=undefined){haveChild=d[treeOption.haveChildName];haveChild=haveChild==true||haveChild=='true'}else if(d[treeOption.childName]){haveChild=d[treeOption.childName].length>0}return haveChild}function addPidField(data,treeOption,parent){for(var i=0;i<data.length;i++){if(parent){data[i][treeOption.pidName]=parent[treeOption.idName]}if(data[i][treeOption.childName]&&data[i][treeOption.childName].length>0){addPidField(data[i][treeOption.childName],treeOption,data[i])}}}function getDataById(data,id,treeOption){for(var i=0;i<data.length;i++){if(data[i][treeOption.idName]==id){return data[i]}if(data[i][treeOption.childName]&&data[i][treeOption.childName].length>0){var d=getDataById(data[i][treeOption.childName],id,treeOption);if(d!=undefined){return d}}}}function delDataById(data,id,treeOption){for(var i=0;i<data.length;i++){if(data[i][treeOption.idName]==id){data.splice(i,1);return true}if(data[i][treeOption.childName]&&data[i][treeOption.childName].length>0){var rs=delDataById(data[i][treeOption.childName],id,treeOption);if(rs){return true}}}}function getPids(list,idName,pidName){var pids=[];for(var i=0;i<list.length;i++){var hasPid=false;for(var j=0;j<list.length;j++){if(i!=j&&list[j][idName]==list[i][pidName]){hasPid=true}}if(!hasPid){pids.push(list[i][pidName])}}return pids}function pidEquals(pId,pIds){if(isClass(pIds)=='Array'){for(var i=0;i<pIds.length;i++){if(pId==pIds[i]){return true}}}else{return pId==pIds}return false}function isClass(o){if(o===null)return'Null';if(o===undefined)return'Undefined';return Object.prototype.toString.call(o).slice(8,-1)}function getPageHeight(){return document.documentElement.clientHeight||document.body.clientHeight}var treeTb={render:function(options){return new TreeTable(options)},on:function(events,callback){return layui.onevent.call(this,MOD_NAME,events,callback)},pidToChildren:function(data,idName,pidName,childName,pId){childName||(childName='children');var newList=[];for(var i=0;i<data.length;i++){(pId==undefined)&&(pId=getPids(data,idName,pidName));if(pidEquals(data[i][pidName],pId)){var children=this.pidToChildren(data,idName,pidName,childName,data[i][idName]);(children.length>0)&&(data[i][childName]=children);newList.push(data[i])}}return newList}};exports('treeTable',treeTb)});